#!/usr/bin/env python
#
# filterator -- filter and format the output of comparator
#
import sys, comparator

if __name__ == '__main__':
    def report_common(state):
        "Generate a report on common code."
        print "Filter-Program: filterator 1.0"
        print "Filtering:", ("none", "language")[dofilter]
        print "Hash-Method: MD5"
        if state.merge_program:
            print "Merge-Program:", state.merge_program
        print "Normalization:", state.normalization
        print "Shred-Size: %d" % state.shredsize
        if minsize:
            print "Minimum-Size: %d" % minsize
        print 75 * '-'
        sys.stdout.write(str(comparator.CommonStatistics(state)))
        print 75 * '-'
        for clique in state.cliques:
            for (file, start, end) in clique:
                if start == 1 and end == state.files[file]:
                    print "%% %s:%d-%d: entire (%d matches)" % \
                          (file, start, end, len(clique))
                    continue
            (text_type, text) = state.extract_text(clique)
            print "%% %s:%d-%d: (%d matches)" % (file, start, end, len(clique))
            sys.stdout.write(state.extract_text(clique)[1])
    # Main line begins here
    import getopt
    try:
        (optlist, args) = getopt.getopt(sys.argv[1:], 'd:ns:Sx')
    except getopt.GetoptError:
        sys.stderr.write("usage: filterator [-d dir] [-m size] [-n] [-x]\n")
        sys.exit(2)
    stats = debug = 0
    dofilter = 1
    minsize = 5
    dir = None
    linecounts = {}
    for (opt, val) in optlist:
        if opt == '-d':
            dir = val
        elif opt == '-m':
            minsize = int(val)
        elif opt == '-n':
            dofilter = 0
        elif opt == '-S':
            stats = 1
        elif opt == '-x':
            debug = 1

    try:
        state = comparator.CommonReport(sys.stdin, dir)
        if minsize:
            state.filter_by_size(minsize)
        if dofilter:
            state.filter_by_significance()

        if stats:
            sys.stdout.write(str(comparator.CommonStatistics(state)))
        else:
            report_common(state)
    except comparator.ComparatorException, e:
        sys.stderr.write("filterator: " + e.message + "\n")
        sys.exit(1)

# End

